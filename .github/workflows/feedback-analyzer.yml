name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æãƒ»è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ 9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ (UTC 0:00 = JST 9:00)
    - cron: '0 0 * * 0'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
    inputs:
      analysis_days:
        description: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æå¯¾è±¡æœŸé–“ï¼ˆæ—¥æ•°ï¼‰'
        required: false
        default: '30'
        type: number
      min_feedback:
        description: 'è‡ªå‹•æ›´æ–°ã«å¿…è¦ãªæœ€å°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°'
        required: false
        default: '10'
        type: number
      min_confidence:
        description: 'è‡ªå‹•æ›´æ–°ã«å¿…è¦ãªæœ€å°ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢'
        required: false
        default: '7'
        type: number
      dry_run:
        description: 'Dry-runãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®å¤‰æ›´ãªã—ï¼‰'
        required: false
        default: false
        type: boolean
      analysis_only:
        description: 'åˆ†æã®ã¿å®Ÿè¡Œï¼ˆè‡ªå‹•æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  analyze-feedback:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0
    
    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: GitHub CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      run: |
        echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
        gh auth status
    
    - name: Gitè¨­å®š
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æå®Ÿè¡Œ
      id: analysis
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "ğŸ§  Starting feedback analysis..."
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
        DAYS="${{ github.event.inputs.analysis_days || '30' }}"
        MIN_FEEDBACK="${{ github.event.inputs.min_feedback || '10' }}"
        MIN_CONFIDENCE="${{ github.event.inputs.min_confidence || '7' }}"
        DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
        ANALYSIS_ONLY="${{ github.event.inputs.analysis_only || 'false' }}"
        
        echo "ğŸ“Š Parameters: days=$DAYS, min_feedback=$MIN_FEEDBACK, min_confidence=$MIN_CONFIDENCE"
        echo "ğŸ§ª Dry run: $DRY_RUN, Analysis only: $ANALYSIS_ONLY"
        
        # ã¾ãšãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æã‚’å®Ÿè¡Œ
        echo "ğŸ“ˆ Running feedback analysis..."
        python src/main.py --analyze-feedback --feedback-days $DAYS --feedback-min 3 --debug
        
        # analysis_onlyãŒtrueã®å ´åˆã¯åˆ†æã®ã¿ã§çµ‚äº†
        if [ "$ANALYSIS_ONLY" = "true" ]; then
          echo "ğŸ“Š Analysis only mode - skipping auto-update"
          echo "analysis_result=analysis_only" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è‡ªå‹•æ›´æ–°å®Ÿè¡Œ
        echo "ğŸ”„ Running auto filter update..."
        if [ "$DRY_RUN" = "true" ]; then
          python src/main.py --auto-update \
            --feedback-days $DAYS \
            --auto-min-feedback $MIN_FEEDBACK \
            --auto-min-confidence $MIN_CONFIDENCE \
            --dry-run --debug
          echo "analysis_result=dry_run_completed" >> $GITHUB_OUTPUT
        else
          python src/main.py --auto-update \
            --feedback-days $DAYS \
            --auto-min-feedback $MIN_FEEDBACK \
            --auto-min-confidence $MIN_CONFIDENCE \
            --debug
          echo "analysis_result=update_completed" >> $GITHUB_OUTPUT
        fi
    
    - name: Slacké€šçŸ¥ï¼ˆæˆåŠŸï¼‰
      if: success()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        RESULT="${{ steps.analysis.outputs.analysis_result }}"
        TRIGGER="${{ github.event_name }}"
        
        if [ "$TRIGGER" = "workflow_dispatch" ]; then
          TRIGGER_TEXT="æ‰‹å‹•å®Ÿè¡Œ"
        else
          TRIGGER_TEXT="é€±æ¬¡è‡ªå‹•å®Ÿè¡Œ"
        fi
        
        case "$RESULT" in
          "analysis_only")
            MESSAGE="ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æå®Œäº† ($TRIGGER_TEXT)\n\nâœ… åˆ†æã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ\nğŸ“ˆ è©³ç´°ã¯ GitHub Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„"
            ;;
          "dry_run_completed")
            MESSAGE="ğŸ§ª ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æãƒ»Dry-runå®Œäº† ($TRIGGER_TEXT)\n\nâœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œå®Œäº†\nğŸ“Š å®Ÿéš›ã®å¤‰æ›´ã¯è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“\nğŸ“ˆ è©³ç´°ã¯ GitHub Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„"
            ;;
          "update_completed")
            MESSAGE="ğŸ¤– ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æãƒ»è‡ªå‹•æ›´æ–°å®Œäº† ($TRIGGER_TEXT)\n\nâœ… åˆ†æã¨è‡ªå‹•æ›´æ–°ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ\nğŸ“ æ–°ã—ã„PRãŒä½œæˆã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\nğŸ”— ãƒªãƒã‚¸ãƒˆãƒªã® Pull Requests ã‚’ã”ç¢ºèªãã ã•ã„"
            ;;
          *)
            MESSAGE="ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æå®Œäº† ($TRIGGER_TEXT)\n\nâœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ\nğŸ“ˆ è©³ç´°ã¯ GitHub Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„"
            ;;
        esac
        
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          "$SLACK_WEBHOOK_URL"
    
    - name: Slacké€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        TRIGGER="${{ github.event_name }}"
        
        if [ "$TRIGGER" = "workflow_dispatch" ]; then
          TRIGGER_TEXT="æ‰‹å‹•å®Ÿè¡Œ"
        else
          TRIGGER_TEXT="é€±æ¬¡è‡ªå‹•å®Ÿè¡Œ"
        fi
        
        MESSAGE="âŒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ ($TRIGGER_TEXT)\n\nğŸ”§ GitHub Actions ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          "$SLACK_WEBHOOK_URL"
    
    - name: å‡¦ç†çµæœã‚µãƒãƒªãƒ¼
      if: always()
      run: |
        echo "=================================="
        echo "ğŸ“Š FEEDBACK ANALYSIS SUMMARY"
        echo "=================================="
        echo "ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}"
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ job.status }}"
        echo "åˆ†æçµæœ: ${{ steps.analysis.outputs.analysis_result }}"
        echo "=================================="